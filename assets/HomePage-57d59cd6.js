import{j as r,u as f,r as i,q as G,w as k,h as J,f as v,o as K,i as U,k as X,L as re,b as S,e as y,_ as Y,l as ne,m as O,d as ae,n as _,p as W,t as Z,v as ce,x as B,y as ie,z as le,O as H}from"./index-b48e6dac.js";import{u as oe,s as $,a as ue,b as de,A as ee,T as P,c as he}from"./useResizeWindow-f5ffb2a2.js";import{L as D}from"./LoaderUIActions-96cbd80d.js";import{S as fe}from"./SearchMsgsInput-b23c1e81.js";function me(e,t){if(e)return e.length<=t?e:e.substring(0,t)+"..."}const xe=({chatUID:e,chatInfo:t,userInfo:s})=>r.jsxs("div",{className:"w-full",children:[r.jsx("p",{className:`font-bold ${e===t[0]?"text-white":"text-zinc-900 dark:text-white"}`,children:s==null?void 0:s.displayName}),r.jsx("p",{className:`${e===t[0]?"text-white":"text-zinc-600 dark:text-zinc-100"}`,children:me(t[1].lastMessage,25)})]}),ge=(e,t)=>{const s=f(a=>a.updateTotalUnreadMessages);i.useEffect(()=>{t[0]&&s(e?{[t[0]]:e}:{[t[0]]:0})},[t,e,s])},pe=({chatInfo:e})=>{const t=oe(e);return ge(t,e),r.jsx(r.Fragment,{children:t>0&&r.jsx("p",{className:"flex justify-center items-center p-1 px-3 border border-white text-white rounded-full shadow-mainShadow bg-gray-500",children:t})})},be=e=>{const[t,s]=i.useState(!0),{uid:a}=f(n=>n.currentUser);return i.useEffect(()=>{if(!e[0]||!a)return;const n=G(J(v,`chats/${e[0]}/messages`),k("isRead","==",!1),k("senderUserID","==",a)),c=K(n,l=>{l.docs.length>0?s(!1):s(!0)});return()=>{c()}},[e,a]),t},ve=({chatInfo:e})=>{const{chatUID:t}=f(n=>n.currentChatInfo),{uid:s}=f(n=>n.currentUser),a=be(e);return r.jsx(r.Fragment,{children:e[1].senderUserID===s&&(a?r.jsx("svg",{width:48,height:48,className:`${t===e[0]?"fill-white":"fill-zinc-800 dark:fill-white"}`,children:r.jsx("use",{href:$+"#icon-double-check",className:"shadow-avatarShadow"})}):r.jsx("svg",{width:48,height:48,className:`${t===e[0]?"fill-white":"fill-zinc-800 dark:fill-white"} drop-shadow-2xl`,children:r.jsx("use",{href:$+"#icon-single-check",className:"drop-shadow-2xl"})}))})},je=({chatInfo:e})=>{const{t}=U(),s=ue(e[1].userUID);return r.jsx("div",{className:`${s?"text-green-700":"text-red-700"}`,children:t(s?"Online":"Offline")})},A=(e,t)=>{t(e)},Ce=({chatInfo:e})=>{const t=X(),{chatUID:s}=f(l=>l.currentChatInfo),a=f(l=>l.updateCurrentChatInfo),n=de(e[1].userUID);console.log("screen --> ChatListItem");const c=()=>{e[0]&&A(e,a)};return r.jsx("li",{className:"block w-full border border-inputChar border-l-transparent border-r-transparent p-2",onClick:c,children:r.jsxs(re,{className:`flex items-center content-center gap-3 h-72px p-1 rounded-md transition-all duration-300 group ${s===e[0]&&"bg-zinc-700 hover:bg-zinc-600 dark:bg-cyan-600 hover:dark:bg-cyan-700"} ${s!==e[0]&&"hover:bg-zinc-400 hover:dark:bg-zinc-700"} `,to:`/${e[0]}`,state:{from:t},children:[r.jsx(ee,{photoURL:n==null?void 0:n.photoURL,displayName:n==null?void 0:n.displayName,size:"50"}),r.jsx(xe,{chatUID:s,chatInfo:e,userInfo:n}),r.jsx(pe,{chatInfo:e}),r.jsx(ve,{chatInfo:e}),r.jsx(je,{chatInfo:e})]})})},ye=()=>{const[e,t]=i.useState(!1),[s,a]=i.useState(null);return i.useEffect(()=>{var c,l,o,h;if(!((l=(c=S)==null?void 0:c.currentUser)!=null&&l.uid))return;t(!0);const n=K(y(v,"userChats",(h=(o=S)==null?void 0:o.currentUser)==null?void 0:h.uid),u=>{const d=u.data();let m=!0;for(const g in d)if(Object.prototype.hasOwnProperty.call(d,g)&&!d[g].date){m=!1;break}if(m&&d){const g=Object.entries(d).sort((b,j)=>j[1].date-b[1].date);a(g),t(!1)}});return()=>{n()}},[]),{isLoading:e,myUserChatList:s}},we=()=>{const{t:e}=U("translation",{keyPrefix:"Sidebar"}),{isLoading:t,myUserChatList:s}=ye();return console.log("screen --> ChatList",s),r.jsxs("div",{children:[t&&r.jsx("div",{className:"flex justify-center",children:r.jsx(D,{size:100})}),!t&&s&&s.length>0?r.jsx("ul",{className:"h-full p-0 m-0",children:s&&s.map(a=>r.jsx(Ce,{chatInfo:a},a[0]))}):r.jsx(r.Fragment,{children:!t&&r.jsx("div",{children:r.jsx("p",{className:"text-center font-black text-black dark:text-white",children:e("NoChats")})})})]})},Ue=i.lazy(()=>Y(()=>import("./NavbarModal-64bcdb68.js"),["assets/NavbarModal-64bcdb68.js","assets/index-b48e6dac.js","assets/index-82baf9a3.css","assets/ModalWindow-37df0ac3.js","assets/useCloseModal-266f730d.js","assets/useResizeWindow-f5ffb2a2.js","assets/useStartTransition-68667600.js"])),Se=()=>{const[e,t]=i.useState(!1),s=()=>{t(a=>!a)};return r.jsxs("div",{children:[r.jsx("div",{className:"relative w-12 h-10 flex justify-center items-center bg-transparent transition-all duration-300 hover:bg-zinc-400 hover:dark:bg-zinc-100/10 rounded-full cursor-pointer",onClick:s,children:r.jsx("svg",{width:32,height:32,className:"fill-zinc-800 dark:fill-zinc-400",children:r.jsx("use",{href:$+"#icon-menu"})})}),r.jsx(i.Suspense,{fallback:r.jsx("div",{className:"absolute top-2 left-4",children:r.jsx(D,{size:40})}),children:e&&r.jsx(Ue,{handleToggleModal:s})})]})},Ne=()=>{const{t:e}=U(),t=f(n=>n.searchValue),s=f(n=>n.updateSearchValue),a=n=>{s(n.target.value)};return r.jsx(fe,{value:t,handleChange:a,placeholderText:e("Search")})};function Re(e,t,s){var a=this,n=i.useRef(null),c=i.useRef(0),l=i.useRef(null),o=i.useRef([]),h=i.useRef(),u=i.useRef(),d=i.useRef(e),m=i.useRef(!0);d.current=e;var g=typeof window<"u",b=!t&&t!==0&&g;if(typeof e!="function")throw new TypeError("Expected a function");t=+t||0;var j=!!(s=s||{}).leading,w=!("trailing"in s)||!!s.trailing,C="maxWait"in s,F="debounceOnServer"in s&&!!s.debounceOnServer,z=C?Math.max(+s.maxWait||0,t):null;i.useEffect(function(){return m.current=!0,function(){m.current=!1}},[]);var te=i.useMemo(function(){var T=function(x){var p=o.current,L=h.current;return o.current=h.current=null,c.current=x,u.current=d.current.apply(L,p)},N=function(x,p){b&&cancelAnimationFrame(l.current),l.current=b?requestAnimationFrame(x):setTimeout(x,p)},q=function(x){if(!m.current)return!1;var p=x-n.current;return!n.current||p>=t||p<0||C&&x-c.current>=z},V=function(x){return l.current=null,w&&o.current?T(x):(o.current=h.current=null,u.current)},E=function x(){var p=Date.now();if(q(p))return V(p);if(m.current){var L=t-(p-n.current),se=C?Math.min(L,z-(p-c.current)):L;N(x,se)}},R=function(){if(g||F){var x=Date.now(),p=q(x);if(o.current=[].slice.call(arguments),h.current=a,n.current=x,p){if(!l.current&&m.current)return c.current=n.current,N(E,t),j?T(n.current):u.current;if(C)return N(E,t),T(n.current)}return l.current||N(E,t),u.current}};return R.cancel=function(){l.current&&(b?cancelAnimationFrame(l.current):clearTimeout(l.current)),c.current=0,o.current=n.current=h.current=l.current=null},R.isPending=function(){return!!l.current},R.flush=function(){return l.current?V(Date.now()):u.current},R},[j,C,t,z,w,b,g,F]);return te}function Le(e,t){return e===t}function Me(e,t){return t}function ke(e,t,s){var a=s&&s.equalityFn||Le,n=i.useReducer(Me,e),c=n[0],l=n[1],o=Re(i.useCallback(function(u){return l(u)},[l]),t,s),h=i.useRef(e);return a(h.current,e)||(o(e),h.current=e),[c,o]}function De(e){return e.charAt(0).toUpperCase()+e.slice(1)}function ze(e){return e.split(" ").map(a=>De(a)).join(" ")}const Te=()=>{const[e,t]=i.useState(!1),[s,a]=i.useState(null),n=f(l=>l.searchValue),[c]=ke(n,300);return i.useEffect(()=>{if(c.trim()===""){a(null);return}return(async()=>{t(!0);const o=ze(c).trim(),h=J(v,"users"),u=G(h,k("displayName",">=",o),k("displayName","<=",o+"ï£¿"));try{const d=await ne(u);a(d)}catch(d){console.error("Error fetching data:",d)}finally{t(!1)}})(),()=>{a(null)}},[c]),{searchChatList:s,setSearchChatList:a,isLoading:e}},Ee=async(e,t,s)=>{var l,o,h,u,d,m,g,b;if(!((o=(l=S)==null?void 0:l.currentUser)!=null&&o.uid))return;const a=(u=(h=S)==null?void 0:h.currentUser)==null?void 0:u.uid,n=e.uid,c=a&&a>n?a+n:n+a;try{(await O(y(v,"chats",c))).exists()||(await ae(y(v,"chats",c),{}),await _(y(v,"userChats",a),{[c+".userUID"]:e.uid,[c+".date"]:W()}),await _(y(v,"userChats",n),{[c+".userUID"]:(d=S)==null?void 0:d.currentUser.uid,[c+".date"]:W()}));const w=await O(y(v,"userChats",a)),C=[c,{lastMessage:(m=w.data())==null?void 0:m[c].lastMessage,senderUserID:(g=w.data())==null?void 0:g[c].senderUserID,userUID:(b=w.data())==null?void 0:b[c].userUID}];A(C,t),s(c)}catch(j){console.log("error handleCreateChat",j)}},Ie=()=>{const e=Z(),{t}=U("translation",{keyPrefix:"Sidebar"}),s=f(u=>u.updateSearchValue),a=f(u=>u.currentUser),n=f(u=>u.updateCurrentChatInfo),{searchChatList:c,setSearchChatList:l,isLoading:o}=Te(),h=u=>{Ee(u,n,e),l(null),s("")};return console.log("searchChatList",c),r.jsxs("div",{className:"px-2",children:[o&&r.jsx(D,{size:50}),!o&&c&&c.size>0?r.jsx("ul",{children:c.docs.map(u=>{if(u.data().uid===a.uid)return null;const d=u.data();return r.jsxs("li",{className:"flex items-center content-center gap-3 h-72px p-2 transition-all duration-300 group hover:bg-zinc-400 rounded-md hover:cursor-pointer",onClick:()=>h(d),children:[r.jsx(ee,{photoURL:d.photoURL,displayName:d.displayName,size:"50"}),r.jsx("p",{className:"text-zinc-600 dark:text-textSecondary font-semibold",children:d.displayName})]},u.id)})}):r.jsx(r.Fragment,{children:!o&&c&&r.jsx("div",{children:r.jsx("p",{className:"text-black dark:text-white font-black",children:t("UsersNotFound")})})})]})},Oe=i.lazy(()=>Y(()=>import("./ProfileSettings-2499be62.js"),["assets/ProfileSettings-2499be62.js","assets/index-b48e6dac.js","assets/index-82baf9a3.css","assets/ButtonArrow-f139700d.js","assets/useResizeWindow-f5ffb2a2.js","assets/useStartTransition-68667600.js","assets/LoaderUIActions-96cbd80d.js"])),Q=()=>{const e=i.useRef(null),t=f(s=>s.sidebarScreen);return console.log("screen --> Sidebar"),r.jsxs("div",{className:"relative w-full h-full bg-gray-200 dark:bg-myBlackBcg sm:min-w-400px sm:w-1/4 border-r border-r-zinc-800",children:[r.jsx(P,{nodeRef:e,in:t==="default",timeout:300,unmountOnExit:!0,children:s=>r.jsxs("div",{ref:e,className:`w-full h-full transform origin-top-left transition-transform 
                  ${s==="exited"?"hidden":""}
                  ${s==="entered"?"rotate-0 translate-x-0":"rotate-180 -translate-x-1/2 duration-300"}
                  `,children:[r.jsxs("div",{className:"flex gap-2 px-3 py-2",children:[r.jsx(Se,{}),r.jsx(Ne,{})]}),r.jsxs("div",{style:{overflow:"scroll",width:"100%",height:"calc(100% - 48px)"},children:[r.jsx(Ie,{}),r.jsx(we,{})]})]})}),t==="profileSettings"&&r.jsx(i.Suspense,{fallback:r.jsx("div",{className:"absolute left-1/2 -translate-x-1/2",children:r.jsx(D,{size:200})}),children:r.jsx(Oe,{})})]})};function M(e){const t=document.querySelector("link[rel='icon']")||document.createElement("link"),s=t;s.type="image/ico",s.rel="icon",s.href=e,document.head.appendChild(t)}const I="/react-web-messenger/assets/faviconTab-e4043aa9.ico",$e="/react-web-messenger/assets/faviconMessageTab-9ae18f2b.ico",Pe=(e,t)=>{const s=i.useRef(null),{t:a}=U("translation",{keyPrefix:"ChatListUnreadMsg"});i.useEffect(()=>{const n="React Web Messenger";return(()=>{if(t){if(e){const l=()=>{document.title===n?(document.title=e===1?`(${e}) ${a("UnreadMessage")}`:`(${e}) ${a("UnreadMessages")}`,M($e)):(document.title=n,M(I))};s.current&&(clearInterval(s.current),s.current=null),s.current=setInterval(l,2e3)}}else M(I),s.current&&(clearInterval(s.current),s.current=null),document.title=n})(),()=>{s.current&&(clearInterval(s.current),s.current=null),M(I),document.title=n}},[e,t,a])},Ae=e=>{const[t,s]=i.useState(0);return i.useEffect(()=>{const a=Object.values(e).reduce((n,c)=>n+=c,0);a!==t&&s(a)},[e,t]),t!==0?t:null},Fe=({docHidden:e})=>{const t=f(a=>a.totalUnreadMessages),s=Ae(t);return Pe(s,e),null},qe=()=>{i.useEffect(()=>{(async()=>{try{const t=await Notification.requestPermission()}catch(t){console.error("Failed to request notification permission:",t)}})()},[])},Ve=()=>{const e=Z(),t=f(a=>a.currentUser.uid),s=f(a=>a.updateCurrentChatInfo);i.useEffect(()=>{async function a(n,c,l){var h,u,d;const o=localStorage.getItem("currentChatId");if(o&&n){const m=await O(y(v,"userChats",n)),g=[o,{lastMessage:(h=m.data())==null?void 0:h[o].lastMessage,senderUserID:(u=m.data())==null?void 0:u[o].senderUserID,userUID:(d=m.data())==null?void 0:d[o].userUID}];c(g,l),e(o)}}a(t,A,s)},[t,e,s])},_e=()=>{const e=f(t=>t.currentUser.uid);i.useEffect(()=>{if(e){const t=ce(le,"status/"+e);B(t,!0);const s=ie(t);return s.set(!1),()=>{s.cancel(),B(t,!1)}}},[e])},We=()=>{const[e,t]=i.useState(!1);return i.useEffect(()=>{const s=()=>{document.hidden?t(!0):t(!1)};return document.addEventListener("visibilitychange",s),()=>{document.removeEventListener("visibilitychange",s)}},[]),e},Be="/react-web-messenger/assets/notify-d07c9a9b.mp3",Ke=i.memo(()=>{const{pathname:e}=X(),t=i.useRef(null),s=i.useRef(null),{t:a}=U(),{isFullScreen:n,heightWindow:c}=he(),l=We();return qe(),_e(),Ve(),console.log("screen --> HomePage"),r.jsxs("div",{className:"flex overflow-hidden bg-main-bcg2 bg-no-repeat bg-cover bg-center",style:{height:`${c}px`},children:[r.jsxs("div",{className:"w-full h-full flex sm:hidden",children:[r.jsx(P,{nodeRef:t,in:window.innerWidth<=640?(e==="/"?"Sidebar":"Chat")=="Sidebar":!1,timeout:300,unmountOnExit:!0,children:o=>r.jsx("div",{ref:t,className:`w-full ${o==="exited"?"hidden":""} transform transition-transform ${o==="entered"?"translate-x-0 scale-100":"-translate-x-full scale-0"}`,children:r.jsx(Q,{})})}),r.jsx(P,{nodeRef:s,in:window.innerWidth<=640?(e==="/"?"Sidebar":"Chat")=="Chat":!1,timeout:300,unmountOnExit:!0,children:o=>r.jsx("div",{ref:s,className:`w-full transform transition-transform 
                  ${o==="exited"?"hidden":""}
                  ${o==="entered"?"translate-x-0 scale-100":"translate-x-full scale-0"}`,children:r.jsx(H,{})})})]}),n&&r.jsxs("div",{className:"hidden sm:flex overflow-hidden",style:{height:`${c}px`},children:[r.jsx(Q,{}),e==="/"&&r.jsx("div",{className:"relative h-full w-screen xl:flex xl:flex-col xl:items-center bg-transparent overflow-hidden",children:r.jsx("h2",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 bg-gray-700 rounded-xl text-center text-white font-black",children:a("EmptyChatNofify")})}),r.jsx(H,{})]}),l&&r.jsx(Fe,{docHidden:l}),r.jsx("audio",{src:Be,id:"notify"})]})});export{Ke as default};
